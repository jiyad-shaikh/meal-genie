{% extends "base.html" %}

{% block title %}Get Your Personalized Diet Plan | MealGenie{% endblock %}
{% block meta_description %}Fill out your preferences to get a fully personalized diet plan based on your goals, lifestyle, and delicious Indian-friendly food choices.{% endblock %}
{% block meta_keywords %}Get diet plan, customized diet plan, healthy meal generator, mealgenie plan, Indian diet plan, Mumbai diet plan, BMR calculator{% endblock %}
{% block og_title %}Get Your MealGenie Diet Plan - The Smart Way to Eat{% endblock %}
{% block og_description %}Enter your goals and preferences to receive your personalized MealGenie diet plan today, featuring tasty and healthy Indian-friendly meals!{% endblock %}
{% block og_image %}{{ url_for('static', filename='images/getplan_share.png') }}{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.x.x/tsparticles.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div id="tsparticles"></div>

<style>
    /* General Styling */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif; /* Changed font */
}

body {
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); /* Dark gradient background */
    color: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    overflow-x: hidden; /* Prevent horizontal scroll */
    position: relative; /* For tsParticles */
}

/* tsParticles Container */
#tsparticles {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 0; /* Ensure particles are behind content */
}

header {
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    position: relative; /* Z-index for header */
    z-index: 1;
}


.form-heading {
    font-size: 38px; /* Slightly larger */
    color: #00ffae;
    animation: slideFade 1s ease forwards; /* Added forwards to keep final state */
    text-align: center;
    font-weight: 700; /* Bolder */
    letter-spacing: 0.5px;
    text-shadow: 0 0 10px rgba(0, 255, 174, 0.4);
}

@keyframes slideFade {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-container {
    background: rgba(255, 255, 255, 0.07);
    backdrop-filter: blur(15px);
    padding: 40px;
    border-radius: 20px;
    width: 100%;
    max-width: 750px; /* Wider form for better layout */
    box-shadow: 0 0 30px rgba(0, 255, 174, 0.4); /* More prominent shadow */
    animation: fadeIn 1.2s ease forwards;
    position: relative; /* For z-index */
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Progress Bar */
.progress-bar-container {
    display: flex;
    justify-content: space-between;
    width: 80%; /* Adjust width as needed */
    margin-bottom: 40px;
    position: relative;
    padding: 0 10px; /* Padding for the circles */
}

.progress-bar-container::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 15px;
    right: 15px;
    height: 4px;
    background: rgba(0, 255, 174, 0.2);
    transform: translateY(-50%);
    z-index: 0;
}

.progress-step {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: rgba(0, 255, 174, 0.2);
    border: 2px solid #00ffae;
    transition: background 0.4s ease, border-color 0.4s ease;
    position: relative;
    z-index: 1; /* Ensure steps are above the line */
}

.progress-step.active {
    background: #00ffae;
    box-shadow: 0 0 15px rgba(0, 255, 174, 0.7);
}

.progress-step.completed {
    background: #00ffae; /* Stays green if completed */
    border-color: #00ffc8;
}

/* Form Steps */
.form-step {
    width: 100%;
    transition: opacity 0.5s ease, transform 0.5s ease;
    padding: 0 10px; /* Inner padding for form content */
}

.form-step.hidden {
    opacity: 0;
    transform: translateX(20px);
    position: absolute; /* To allow smooth transition of container height */
    pointer-events: none; /* Disable interaction */
}

.form-step.active-step {
    opacity: 1;
    transform: translateX(0);
    position: relative;
    pointer-events: auto;
}

.step-title {
    font-size: 26px;
    color: #00ffae;
    text-align: center;
    margin-bottom: 30px;
    font-weight: 600;
    text-shadow: 0 0 5px rgba(0, 255, 174, 0.2);
}

/* Form Groups */
.form-group {
    position: relative;
    margin-bottom: 30px;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 14px 18px; /* Increased padding */
    border-radius: 10px;
    border: 1px solid #00ffae;
    background: rgba(0, 0, 0, 0.4);
    color: white;
    outline: none;
    transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
    font-size: 17px; /* Slightly larger font */
    box-shadow: 0 0 5px rgba(0, 255, 174, 0.1);
    appearance: none; /* For custom select arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #00ffc8;
    background-color: rgba(0, 0, 0, 0.6);
    box-shadow: 0 0 15px rgba(0, 255, 174, 0.5); /* Glowing effect on focus */
}

.form-group select {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%2300ffae" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 20px;
    padding-right: 40px; /* Space for the arrow */
}


.form-group label {
    position: absolute;
    top: 14px;
    left: 18px; /* Adjusted left padding */
    background: transparent; /* Changed to transparent, background on focus via JS */
    padding: 0 5px;
    color: #aaa;
    pointer-events: none;
    transition: 0.3s ease-in-out;
    font-size: 17px;
    transform-origin: left top;
}

/* Floating Label effect */
.form-group input:focus + label,
.form-group input:not(:placeholder-shown) + label,
.form-group select:focus + label,
.form-group select:not([value=""]) + label {
    top: -10px;
    left: 10px;
    font-size: 13px; /* Smaller font when floated */
    color: #00ffc8;
    background: rgba(0, 0, 0, 0.6); /* Background for the label when floated */
    padding: 0 8px;
    border-radius: 4px;
    transform: translateY(0);
}

.read-only-input {
    background: rgba(0, 0, 0, 0.2) !important;
    border: 1px dashed rgba(0, 255, 174, 0.5) !important; /* Dotted border for readonly */
    cursor: default !important;
}

.read-only-input + label {
    color: #00ffae !important;
}

.tooltip-icon {
    font-size: 14px;
    color: #00ffae;
    margin-left: 8px;
    cursor: help;
    position: relative;
}

.tooltip-icon::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 120%; /* Position above icon */
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    pointer-events: none;
    z-index: 10;
}

.tooltip-icon:hover::after {
    opacity: 1;
    visibility: visible;
}


/* Buttons */
.btn {
    background: linear-gradient(90deg, #00ffae, #00ffc8); /* Gradient button */
    border: none;
    padding: 16px 25px; /* Wider padding */
    width: 100%;
    border-radius: 10px;
    color: #0d1e2b; /* Darker text for contrast */
    cursor: pointer;
    font-size: 18px;
    font-weight: 600;
    transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px; /* Space between text and icon */
    box-shadow: 0 5px 15px rgba(0, 255, 174, 0.3);
}

.btn:hover {
    background: linear-gradient(90deg, #00ffc8, #00ffae); /* Reverse gradient on hover */
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 255, 174, 0.5);
}

.btn i {
    font-size: 16px;
}

.button-group {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 20px;
}

.button-group .btn {
    width: 48%; /* Make buttons take half width */
}

.back-btn {
    background: transparent;
    border: 1px solid #00ffae;
    color: #00ffae;
    box-shadow: none;
}

.back-btn:hover {
    background: rgba(0, 255, 174, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 0 10px rgba(0, 255, 174, 0.4);
}

/* Plan Selection Grid */
.plan-subtitle {
    text-align: center;
    margin-bottom: 30px;
    font-size: 1.1em;
    color: #c9c9c9;
}

.plan-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Responsive grid */
    gap: 25px;
    margin-bottom: 40px;
    width: 100%;
}

.plan-card {
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(0, 255, 174, 0.3);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    min-height: 280px; /* Ensure consistent height */
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
}

.plan-card input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.plan-card .card-content {
    width: 100%;
}

.plan-card:hover {
    border-color: #00ffc8;
    background: rgba(0, 0, 0, 0.6);
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 255, 174, 0.4);
}

.plan-card input[type="radio"]:checked + .card-content {
    border: 2px solid #00ffae; /* Visible border on selection */
    box-shadow: 0 0 25px rgba(0, 255, 174, 0.7);
    transform: translateY(-8px); /* More pronounced lift */
    background: rgba(0, 255, 174, 0.1);
}

/* Ensure the checkmark for the selected card */
.plan-card input[type="radio"]:checked + .card-content::before {
    content: '\f00c'; /* Font Awesome check icon */
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    top: 15px;
    right: 15px;
    color: #00ffae;
    font-size: 24px;
    opacity: 1;
    transition: opacity 0.3s;
}
.plan-card .card-content::before {
    content: ''; /* Hide checkmark by default */
    opacity: 0;
    position: absolute;
    top: 15px;
    right: 15px;
    transition: opacity 0.3s;
}

.plan-tag {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #00ffae;
    color: #0d1e2b;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.5px;
    box-shadow: 0 3px 10px rgba(0, 255, 174, 0.4);
    z-index: 2;
}

.plan-tag.premium {
    background: linear-gradient(45deg, #FFD700, #FFA500); /* Gold gradient for premium */
    color: #5a3c00;
    box-shadow: 0 3px 10px rgba(255, 215, 0, 0.6);
}

.plan-tag.best-value {
    background: linear-gradient(45deg, #1abc9c, #2ecc71); /* Greenish for best value */
    color: white;
    box-shadow: 0 3px 10px rgba(46, 204, 113, 0.6);
}


.plan-card h4 {
    font-size: 24px;
    margin-top: 25px; /* Space for tag */
    margin-bottom: 10px;
    color: #00ffae;
    font-weight: 600;
}

.plan-card p {
    font-size: 15px;
    color: #c9c9c9;
    margin-bottom: 20px;
    line-height: 1.4;
}

.plan-card .price {
    font-size: 32px;
    font-weight: 700;
    color: #00ffae;
    margin-top: auto; /* Pushes price to bottom */
    margin-bottom: 15px;
}

.plan-card .cta-text {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #00ffc8;
    background: rgba(0, 255, 174, 0.1);
    padding: 8px 15px;
    border-radius: 8px;
    margin-top: 10px;
    transition: background 0.3s;
}

.plan-card input[type="radio"]:checked + .card-content .cta-text {
    background: #00ffc8;
    color: #0d1e2b;
}

.features-list {
    list-style: none;
    padding: 0;
    margin-bottom: 20px;
    text-align: left;
}

.features-list li {
    font-size: 14px;
    color: #e0e0e0;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
}

.features-list li i {
    margin-right: 8px;
    color: #00ffae; /* Checkmark color */
}
.features-list li .grey-icon {
    color: #888; /* Grey for 'not included' features */
}


/* Footer */
footer {
    margin-top: 40px;
    text-align: center;
    color: #aaa;
    font-size: 14px;
    width: 100%;
    position: relative; /* For z-index */
    z-index: 1;
}

.footer-content {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 15px 30px; /* Row-gap, column-gap */
    padding: 0 20px;
}

.footer-links a,
.footer-legal a {
    color: #00ffae;
    margin: 0 10px;
    text-decoration: none;
    transition: color 0.3s, text-decoration 0.3s;
}

.footer-links a:hover,
.footer-legal a:hover {
    color: #00ffc8;
    text-decoration: underline;
}

.footer-legal p {
    margin: 0;
}

.footer-social a {
    color: #00ffae;
    font-size: 20px;
    margin: 0 10px;
    transition: color 0.3s, transform 0.3s;
}

.footer-social a:hover {
    color: #00ffc8;
    transform: scale(1.2);
}



/* Responsive Adjustments */
@media (max-width: 768px) {
    .form-heading {
        font-size: 30px;
    }

    .form-container {
        padding: 30px 20px;
        border-radius: 15px;
    }

    .step-title {
        font-size: 22px;
        margin-bottom: 25px;
    }

    .form-group input,
    .form-group select {
        padding: 12px 15px;
        font-size: 16px;
    }

    .form-group label {
        font-size: 16px;
        top: 12px;
        left: 15px;
    }

    .form-group input:focus + label,
    .form-group input:not(:placeholder-shown) + label,
    .form-group select:focus + label,
    .form-group select:not([value=""]) + label {
        top: -8px;
        left: 8px;
        font-size: 11px;
    }

    .btn {
        font-size: 16px;
        padding: 14px 20px;
    }

    .button-group {
        flex-direction: column;
        gap: 15px;
    }

    .button-group .btn {
        width: 100%;
    }

    .plan-selection-grid {
        grid-template-columns: 1fr; /* Stack cards on mobile */
        gap: 20px;
    }

    .plan-card {
        min-height: unset; /* Allow height to adjust for content */
        padding: 20px;
    }

    .plan-card h4 {
        font-size: 22px;
        margin-top: 20px;
    }

    .plan-card .price {
        font-size: 28px;
    }

    .plan-card .cta-text {
        font-size: 15px;
    }

    footer .footer-content {
        flex-direction: column;
        gap: 15px;
    }
}

@media (max-width: 480px) {
    .form-heading {
        font-size: 26px;
    }
    .form-container {
        padding: 25px 15px;
    }
    .progress-bar-container {
        width: 90%;
    }
    .plan-card .plan-tag {
        font-size: 12px;
        padding: 5px 12px;
    }
}
</style>

<header>
    <h2 class="form-heading">Your Personalized Meal Plan Journey</h2>
</header>

<section class="form-container">
    <div class="progress-bar-container">
        <div class="progress-step active" data-step="1"></div>
        <div class="progress-step" data-step="2"></div>
        <div class="progress-step" data-step="3"></div>
    </div>

    <form id="dietPlanForm" action="/generate-plan" method="post">
        <div class="form-step" id="step-1">
            <h3 class="step-title">1. Tell Us About Yourself</h3>
            <div class="form-group">
                <input type="number" id="age" name="age" required placeholder=" ">
                <label for="age">Age (Years)</label>
            </div>

            <div class="form-group">
                <select id="gender" name="gender" required>
                    <option value="" disabled selected>Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
                <label for="gender">Gender</label>
            </div>

            <div class="form-group">
                <select id="preference" name="preference" required>
                    <option value="" disabled selected>Select Food Preference</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="non-vegetarian">Non-Vegetarian</option>
                </select>
                <label for="preference">Food Preference</label>
            </div>

            <div class="form-group">
                <select id="activity" name="activity" required>
                    <option value="" disabled selected>Select Activity Level</option>
                    <option value="Sedentary">Sedentary (Little to no exercise)</option>
                    <option value="Moderate">Moderate (Moderate exercise/sports 3-5 days/week)</option>
                    <option value="Active">Active (Daily exercise/sports or physical job)</option>
                </select>
                <label for="activity">Activity Level</label>
            </div>

            <button type="button" class="btn next-btn" data-next-step="2">Next Step <i class="fas fa-arrow-right"></i></button>
        </div>

        <div class="form-step hidden" id="step-2">
            <h3 class="step-title">2. Your Current & Target Goals</h3>
            <div class="form-group">
                <input type="number" id="height" name="height" required placeholder=" " min="50" max="250">
                <label for="height">Height (in cm)</label>
            </div>

            <div class="form-group">
                <input type="number" id="weight" name="weight" required placeholder=" " min="20" max="300">
                <label for="weight">Weight (in kg)</label>
            </div>

            <div class="form-group">
                <input type="text" id="suggested-goal" readonly placeholder=" " class="read-only-input">
                <label for="suggested-goal">Suggested Goal <i class="fas fa-info-circle tooltip-icon" data-tooltip="Based on your BMI, we've suggested a fitness goal. You can adjust it below."></i></label>
            </div>

            <div class="form-group">
                <select id="goal" name="goal" required>
                    <option value="" disabled selected>Choose Your Fitness Goal</option>
                    <option value="Weight Loss">Weight Loss</option>
                    <option value="Muscle Gain">Muscle Gain</option>
                    <option value="General Health">General Health / Maintenance</option>
                </select>
                <label for="goal">Fitness Goal</label>
            </div>
            <div class="button-group">
                <button type="button" class="btn back-btn" data-prev-step="1"><i class="fas fa-arrow-left"></i> Back</button>
                <button type="button" class="btn next-btn" data-next-step="3">Next Step <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div class="form-step hidden" id="step-3">
            <h3 class="step-title">3. Choose Your Meal Plan</h3>
            <p class="plan-subtitle">Select a plan duration to get your personalized, Mumbai-friendly meal plan.</p>

            <div class="plan-selection-grid">
                <label class="plan-card" for="plan-1-day">
                    <input type="radio" id="plan-1-day" name="plan_duration" value="1-day" required checked>
                    <div class="card-content">
                        <span class="plan-tag free">FREE</span>
                        <h4>1-Day Trial</h4>
                        <p>Experience a taste of personalized healthy eating.</p>
                        <ul class="features-list">
                            <li><i class="fas fa-check-circle"></i> Daily meal plan</li>
                            <li><i class="fas fa-check-circle"></i> Healthy, tasty & Indian-friendly recipes</li>
                            <li><i class="fas fa-times-circle grey-icon"></i> Limited customization</li>
                        </ul>
                        <span class="price">₹0</span>
                        <span class="cta-text">Get Started Free!</span>
                    </div>
                </label>

                <label class="plan-card" for="plan-3-day">
                    <input type="radio" id="plan-3-day" name="plan_duration" value="3-day-premium" required>
                    <div class="card-content">
                        <span class="plan-tag premium">PREMIUM</span>
                        <h4>3-Day Kickstart (CURRENTLY UNAVAILABLE) </h4>
                        <p>A short boost to achieve your immediate goals.</p>
                        <ul class="features-list">
                            <li><i class="fas fa-check-circle"></i> 3-Day meal plan</li>
                            <li><i class="fas fa-check-circle"></i> Advanced meal swapping</li>
                            <li><i class="fas fa-check-circle"></i> Basic ingredient exclusion</li>
                        </ul>
                        <span class="price">₹199</span>
                        <span class="cta-text">Select Plan</span>
                    </div>
                </label>

                <label class="plan-card" for="plan-7-day">
                    <input type="radio" id="plan-7-day" name="plan_duration" value="7-day-premium" required>
                    <div class="card-content">
                        <span class="plan-tag premium best-value">PREMIUM</span>
                        <h4>7-Day Full Immersion  (CURRENTLY UNAVAILABLE)</h4>
                        <p>Comprehensive weekly plan for sustainable results. **Most Popular!**</p>
                        <ul class="features-list">
                            <li><i class="fas fa-check-circle"></i> 7-Day comprehensive plan</li>
                            <li><i class="fas fa-check-circle"></i> Unlimited meal customization</li>
                            <li><i class="fas fa-check-circle"></i> Full ingredient exclusion</li>
                            <li><i class="fas fa-check-circle"></i> Daily motivation & tips</li>
                        </ul>
                        <span class="price">₹499</span>
                        <span class="cta-text">Select Plan</span>
                    </div>
                </label>
            </div>
            <div class="button-group">
                <button type="button" class="btn back-btn" data-prev-step="2"><i class="fas fa-arrow-left"></i> Back</button>
                <button type="submit" class="btn get-plan-btn"><i class="fas fa-robot"></i> Get My Plan!</button>
            </div>
        </div>
    </form>
</section>

<script>
    // Theme Toggle Logic
    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeIcon = themeToggleBtn.querySelector('i');

    function updateThemeIcon() {
        if (document.body.classList.contains('light-mode')) {
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        } else {
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        }
    }

    themeToggleBtn.addEventListener("click", () => {
        document.body.classList.toggle("light-mode");
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        updateThemeIcon();
    });

    // Load theme on page load and update icon
    window.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-mode');
        }
        updateThemeIcon(); // Set initial icon based on loaded theme
    });

    // Form Steps Logic
    const formSteps = document.querySelectorAll('.form-step');
    const progressSteps = document.querySelectorAll('.progress-step');
    const nextButtons = document.querySelectorAll('.next-btn');
    const backButtons = document.querySelectorAll('.back-btn');
    let currentStep = 1;

    // Helper function to update label position
    function updateLabelPosition(element) {
        const label = element.nextElementSibling;
        if (label && label.tagName === 'LABEL') {
            // Check for actual value, or if it's a select, check if a non-disabled option is selected
            const hasValue = element.value.trim() !== '';
            const isSelectDefault = element.tagName === 'SELECT' && element.value === element.querySelector('option[disabled]')?.value;

            if (hasValue && !isSelectDefault) {
                label.classList.add('active-label');
            } else {
                label.classList.remove('active-label');
            }
        }
    }

    // Initialize labels for all inputs/selects on page load
    document.querySelectorAll('.form-group input, .form-group select').forEach(input => {
        updateLabelPosition(input); // Initial check
        input.addEventListener('input', () => updateLabelPosition(input)); // On user input
        input.addEventListener('change', () => updateLabelPosition(input)); // For selects
        input.addEventListener('focus', () => { // Ensure label floats on focus
            const label = input.nextElementSibling;
            if (label && label.tagName === 'LABEL') {
                label.classList.add('active-label');
            }
        });
        input.addEventListener('blur', () => { // Remove label float if input becomes empty
            const label = input.nextElementSibling;
            if (label && label.tagName === 'LABEL') {
                const hasValue = input.value.trim() !== '';
                const isSelectDefault = input.tagName === 'SELECT' && input.value === input.querySelector('option[disabled]')?.value;
                if (!hasValue || isSelectDefault) {
                    label.classList.remove('active-label');
                }
            }
        });
    });


    function showStep(stepNumber) {
        formSteps.forEach(step => {
            step.classList.remove('active-step'); // Remove active from all
            step.classList.add('hidden'); // Hide all
        });
        const targetStep = document.getElementById(`step-${stepNumber}`);
        if (targetStep) {
            targetStep.classList.remove('hidden');
            targetStep.classList.add('active-step');
        }

        progressSteps.forEach((pStep, index) => {
            if (index + 1 < stepNumber) {
                pStep.classList.add('completed');
                pStep.classList.remove('active');
            } else if (index + 1 === stepNumber) {
                pStep.classList.add('active');
                pStep.classList.remove('completed');
            } else {
                pStep.classList.remove('active', 'completed');
            }
        });

        // Ensure labels are correctly floated on the newly active step
        document.querySelectorAll(`#step-${stepNumber} .form-group input, #step-${stepNumber} .form-group select`).forEach(input => {
            updateLabelPosition(input);
        });
    }

    nextButtons.forEach(button => {
        button.addEventListener('click', () => {
            const currentFormStep = document.getElementById(`step-${currentStep}`);
            const inputs = currentFormStep.querySelectorAll('input[required], select[required]');
            let allValid = true;

            inputs.forEach(input => {
                // Manually check validity for custom styled selects/inputs
                const isSelectDefault = input.tagName === 'SELECT' && input.value === input.querySelector('option[disabled]')?.value;

                if (!input.value.trim() || isSelectDefault) {
                    allValid = false;
                    input.reportValidity(); // Trigger browser's native validation message
                }
            });

            if (allValid) {
                currentStep = parseInt(button.dataset.nextStep);
                showStep(currentStep);
            }
        });
    });

    backButtons.forEach(button => {
        button.addEventListener('click', () => {
            currentStep = parseInt(button.dataset.prevStep);
            showStep(currentStep);
        });
    });

    // Initial step display
    showStep(currentStep);


    // BMI based Suggested Goal
    function suggestGoal() {
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);
        const goalField = document.getElementById('goal');
        const suggestedField = document.getElementById('suggested-goal');

        if (height > 0 && weight > 0) {
            const hMeters = height / 100;
            const bmi = weight / (hMeters * hMeters);
            let suggestion = '';

            if (bmi < 18.5) {
                suggestion = 'Underweight (Suggest: Muscle Gain)';
                goalField.value = 'Muscle Gain';
            } else if (bmi >= 25 && bmi < 30) {
                suggestion = 'Overweight (Suggest: Weight Loss)';
                goalField.value = 'Weight Loss';
            } else if (bmi >= 30) {
                suggestion = 'Obese (Suggest: Weight Loss)';
                goalField.value = 'Weight Loss';
            } else { // BMI between 18.5 and 24.9
                suggestion = 'Healthy Weight (Suggest: General Health)';
                goalField.value = 'General Health';
            }

            suggestedField.value = suggestion;
            updateLabelPosition(suggestedField); // Ensure suggested goal label floats

        } else {
            suggestedField.value = '';
            goalField.value = ''; // Reset goal field
            updateLabelPosition(suggestedField);
        }
    }

    document.getElementById('height').addEventListener('input', suggestGoal);
    document.getElementById('weight').addEventListener('input', suggestGoal);
    // Run on page load if values are pre-filled (e.g., from browser autofill)
    window.addEventListener('load', suggestGoal);

     const dietPlanForm = document.getElementById('dietPlanForm');

    dietPlanForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission initially

        // Get the selected plan duration
        const selectedPlanRadio = document.querySelector('input[name="plan_duration"]:checked');
        const planDuration = selectedPlanRadio ? selectedPlanRadio.value : null;

        if (planDuration === '1-day') {
            // For 1-day free plan, submit the form as POST to /result
            this.action = '/result'; // Ensure form posts to /result
            this.method = 'post';
            this.submit();
        } else if (planDuration === '3-day-premium' || planDuration === '7-day-premium') {
            // For premium plans, allow the form to submit to the backend
            // The backend will then handle payment logic and subsequent redirection
            this.submit(); // Programmatically submit the form
        } else {
            // Fallback for no plan selected (shouldn't happen with 'required' attribute)
            alert('Please select a plan duration.');
        }
    });

    // tsParticles Configuration
    tsParticles.load("tsparticles", {
        fullScreen: { enable: false },
        particles: {
            number: { value: 80, density: { enable: true, area: 800 } },
            color: { value: "#00ffae" },
            shape: { type: "circle" },
            opacity: { value: 0.5, random: true },
            size: { value: 3, random: true },
            move: { enable: true, speed: 1.5, direction: "none", outModes: "out" },
            links: { enable: true, distance: 150, color: "#00ffae", opacity: 0.4, width: 1 }
        },
        interactivity: {
            events: { onHover: { enable: true, mode: "repulse" }, onClick: { enable: true, mode: "push" } },
            modes: { repulse: { distance: 100 }, push: { quantity: 4 } }
        },
        detectRetina: true
    });
</script>

{% endblock %}